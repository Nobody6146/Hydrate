<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"/>
        <title>Hydrate Demo</title>
        <script src="hydrate.js"></script>
        <style>
            .red {
                color: red;
            }
        </style>
    </head>
    <body>

        <div>
            <header>
            
            </header>
    
            <!-- <main>
                <input h-model="default" h-property="text value" h-input="text value" value="Testing">
                <div h-model="default" h-property="text innerHTML" h-attribute="text name">
                    Sample text
                </div>
                <div h-model="default.object" h-property="text innerHTML" h-attribute="text name">
                    Sample text 2
                </div>
            </main> -->
    
            <template h-template="Example-template" h-model>
                <h1>Example Component</h1>
                <p h-model="^.name" h-property="textContent: `${first} ${last}`"></p>
            </template>
            <template h-template="List-template">
                <li h-model="^" h-property="textContent: `key: ${$detail.modelName}, value: ${$detail.state}`"></li>
            </template>
            <template h-template="Selector-template">
                <option h-model="^" h-property="textContent: name; value: value;">Option</option>
            </template>

            <template h-template="HomePage-template" h-model h-routing="resolve">
                <h1>Home</h1>
            </template>
            <template h-template="ContactPage-template" h-model h-route="#contact">
                <loadingpage-template></loadingpage-template>
                <contactpagecontent-template></ContactPageContent-template>
                <rejectedpage-template></rejectedpage-template>
            </template>
            <template h-template="ContactPageContent-template" h-model h-routing="resolve">
                <h1>Contact</h1>
            </template>
            <template h-template="PageNotFound-template"  h-model h-route="#404" h-routing="resolve" h-event="routing.resolve: document.title = 'Demo | 404'">
                <h1>Page not found!</h1>
            </template>
            <template h-template="LoadingPage-template" h-model h-routing="start" h-event="routing.start: document.title = 'Demo | Contact'">
                Loading...
            </template>
            <template h-template="RejectedPage-template" h-model h-routing="reject">
                Error loading page
            </template>
            <template h-template="aboutpage-template" h-model h-source="demopages/about.html"></template>


            <template h-template="Star-template">
                <div h-model="^" h-property="innerText: $id() <= $state ? '&#9733' : '&#9734'" h-id
                    h-on="click: $detail.parent[$detail.modelName] = $id()">
                Star</div>
            </template>

            <template h-template="calculator-template" h-model="default.calculator" h-lazy>
                <style>

                </style>
                <p>This calculator calculates the square of numbers less than 20!</p>
                <input id="calculator" h-model="^" h-property="value: value" h-input="value: $element.value" h-if="input: $element.value < 20">
                <h1 h-model="^" h-property="textContent: $component.calculate(value)"></h1>
                <script h-script>
                    {
                        calculate: function(value) {
                            return value * value;
                        },
                        onInit: function(eventDetail) {
                            console.log("initialize calculator", eventDetail);
                            console.log(this);
                            this.$model.value = 10;
                        },
                        onRender: function(eventDetail) {
                            console.log("Rendered calculator", eventDetail);
                        },
                        onDestroy: function() {
                            console.log("initialize calculator");
                            this.$hydrate.unbind(this.$model);
                        }
                    }
                </script>
            </template>


            <main>

                <div>
                    <h1>
                        Welcome
                    </h1>
                    
                    <div>
                        <div h-route="#home">
                            <div h-model h-routing="start" h-event="routing.start: document.title = 'Demo | Home'"></div>
                            <homepage-template></homepage-template>
                        </div>
                        <aboutpage-template></aboutpage-template>
                        <contactpage-template>
                            Check
                        </contactpage-template>
                        <pageNotFound-template></PageNotFound-template>
                    </div>
                </div>

                <a href="#home">Home</a>
                <a href="#about">About</a>
                <a href="#contact">Contact</a>
                <a href="#badUrl">Bad Link</a>
                <a href="?sort=Top#test/3">Test Link</a>

                <div h-model="default" h-remove>
                    We are a deleteable div!
                </div>
                <div h-model h-property="textContent: 'Overrided text from modeless component!'">Same Text</div>
                <input h-model="default" h-property="value: text" h-input="text: $element.value" value="Testing" h-event="track: console.log('got data!', $detail)" h-throttle="input: 750">
                <input h-model="default" h-property="value: text" h-on="input: $model.text = $element.value" h-debounce="on: 750">
                <input h-model="default" h-property="value: text" h-on="input: $model.text = $element.value" h-delay="on: 1000">
                <button h-model="default" h-on="click: alert(`Hello! Text: ${text}`);click: console.log('clicked me!')">Alert</button>
                <div h-model="default" h-property="'innerHTML': text" h-attribute="name: text">
                    Sample text
                </div>
                <example-template>
                    Placeholder text that will be deleted
                </div>

                <list-template h-model="default.list">
                    Placeholder list will be deleted
                </list-template>
                <p h-model="default.person.name" h-property="textContent: `${first} ${last}`">lnkjhk</p>
                <p h-model="default.person.name" h-property="textContent: first"></p>

                <p h-model h-lazy h-event="track: console.log('lazy loaded element')" h-property="textContent: 'Lazy loaded text'"></p>

                <select h-model="default.selector" h-property="value: value" h-mutation="child: added">
                    <option selected value="" disabled>Select Value</option>
                    <optgroup h-model="default.selector.options" h-component="selector-template">
                        <option>Test 1</option>
                        <option>Test 2</option>
                    </optgroup>
                </select>

                <input h-model="default.toggle" h-class="red: shouldRed" h-toggle="disabled: shouldDisable" value="Test" >
                
                <star-template h-model="default.rank" h-duplicate="5"
                    style="display: flex;">
                </star-template>

                <calculator-template h-lazy></calculator-template>

                <p h-model="testInitAttribute.nonExistiant.property" h-init h-property="textContent: 'We initialized this model that did not exist!'"></p>
            </main>
    
            <footer>
                <p>
                    Hydrate Demo 2022.
                </p>
            </footer>
            <script>
                // document.body.addEventListener("hydrate.track", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.untrack", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.bind", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.set", event => console.log(event.type, event.detail));
                //document.body.addEventListener("hydrate.unbind", event => console.log(event.type, event.detail));

                // document.body.addEventListener("hydrate.mutation.parent.attribute", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.mutation.parent.added", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.mutation.parent.removed", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.mutation.parent.characters", event => console.log(event.type, event.detail));
                // //
                //document.body.addEventListener("hydrate.mutation.target.attribute", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.mutation.target.added", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.mutation.target.removed", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.mutation.target.characters", event => console.log(event.type, event.detail));
                // //
                // document.body.addEventListener("hydrate.mutation.child.attribute", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.mutation.child.added", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.mutation.child.removed", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.mutation.child.characters", event => console.log(event.type, event.detail));
                // //
                // document.body.addEventListener("hydrate.route", event => console.log(event.type, event.detail));
                //
                //document.body.addEventListener("hydrate.input", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.on", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.routing.start", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.routing.resolve", event => console.log(event.type, event.detail));
                // document.body.addEventListener("hydrate.routing.reject", event => console.log(event.type, event.detail));
                

                let options = {
                    debug: {
                        dispatchTimer: false
                    }
                };
                let app = new HydrateApp(options);
                let div = document.querySelector("div");
                //let model = app.bind("default", {text: "hello", list: [{first: "Brandon", last: "Biera"}, {first:"Megan",last:"Wong"}]});
                let model = app.bind("default", {text: "hello", list: [1,2,3,4], person: {name: {first: "Brandon", last: "Biera"}}});
                model.selector = {
                    options: [
                        {name: "Car", value: 1},
                        {name: "Boat", value: 2},
                        {name: "Plane", value: 3},
                    ],
                    value: 3
                }
                model.toggle = {
                    shouldRed: false,
                    shouldDisable: false
                }
                model.rank = 3;
                model.calculator = {
                    value: 0
                }

                //Define our client side routes
                let routeMap = [];
                routeMap.push({
                    path: "",
                    action: (resolvedRoute, request) => {
                        //Logging middleware
                        console.log(request);
                    }
                });
                routeMap.push({
                    path: "#",
                    action: (resolvedRoute, request) => {
                        request.redirect("#home");
                    }
                });
                routeMap.push({
                    path: "#home",
                    action: (resolvedRoute, request) => {
                        //console.log(resolvedRoute);
                        request.resolve();
                    }
                });
                routeMap.push({
                    path: "#about",
                    action: (resolvedRoute, request) => {
                        //console.log(resolvedRoute);
                        request.resolve();
                    }
                });
                routeMap.push({
                    path: "#contact",
                    action: (resolvedRoute, request) => {
                        throw Error("testing broken route");
                        //request.resolve();
                    }
                });
                routeMap.push({
                    path: "#404",
                    action: (resolvedRoute, request) => {
                        //console.log(resolvedRoute);
                        request.resolve();
                    }
                });
                routeMap.push({
                    path: "#test/:id",
                    action: (resolvedRoute, request) => {
                        //console.log(resolvedRoute);
                        request.resolve();
                    }
                });
                routeMap.push({
                    path: "",
                    action: (resolvedRoute, request) => {
                        //Page not found
                        //console.log(resolvedRoute);
                        request.redirect(`?page=3#404`);
                    }
                });

                //Create our routing middleware
                document.body.addEventListener("hydrate.routing.start", event => {
                    let request = event.detail.request;
                    try{
                        let matchedResults = request.match(request.url, ...routeMap);
                        for(let result of matchedResults)
                        {
                            let route = result.route;
                            route.action(route, request);
                            if(request.handled)
                                break;
                        }
                    }
                    catch(err) {
                        console.error(err);
                        request.reject();
                    }
                });

                //Route to current page
                app.route();

                // let event = new HydrateModelEvent();
                // event.target = div;
                // event.hydrate = app;
                // event.type = "bind";
                // event.propPath = "default.text";
                // event.prop = "hello world";
                // app.dispatch(event);
            </script>
        </div>
        
    </body>
</html>