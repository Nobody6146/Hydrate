<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"/>
        <title>Todo List Demo</title>
        <script src="hydrate.js"></script>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400&display=swap");
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: "Poppins", sans-serif;
            }

            .container {
                max-width: 500px;
                margin: 30px auto;
                overflow: auto;
                min-height: 300px;
                border: 1px solid steelblue;
                padding: 30px;
                border-radius: 5px;
            }
            .btn {
                display: inline-block;
                background: #000;
                color: #fff;
                border: none;
                padding: 10px 20px;
                margin: 5px;
                border-radius: 5px;
                cursor: pointer;
                text-decoration: none;
                font-size: 15px;
                font-family: inherit;
            }
            .btn:focus {
                outline: none;
            }
            .btn:active {
                transform: scale(0.98);
            }

            .btn-block {
                display: block;
                width: 100%;
            }

            .form-control {
                margin: 20px 0;
            }

            .form-control label {
                display: block;
            }

            .form-control input {
                width: 100%;
                height: 40px;
                margin: 5px;
                padding: 3px 7px;
                font-size: 17px;
            }

            .form-control-check {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .form-control-check label {
                flex: 1;
            }

            .form-control-check input {
                flex: 2;
                height: 20px;
                }

            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            footer {
                margin-top: 30px;
                text-align: center;
            }

            .task {
                background: #f4f4f4;
                margin: 5px;
                padding: 10px 20px;
                cursor: pointer;
            }
            
            .task.reminder {
                border-left: 5px solid green;
            }
            
            .task h3 {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .add-form {
                margin-bottom: 40px;
            }
        </style>
    </head>
    <body>

        <template h-template="app-header" h-model="header">
            <header>
                <h1 h-model="^" h-property="textContent: title"> </h1>
                <app-button
                    h-model="ui.addTask.button"
                >
                </app-button>
            </header>
            <script h-script>
                {
                    onInit(detail) {
                        let button = this.$hydrate.bind("addTaskButton");
                        button.text = "Add";
                    }
                }
            </script>
        </template>

        <template h-template="app-button">
            <button class="btn"
                h-model="^"
                h-property="textContent: text"
                h-attribute="style: `background-color: ${color}`"
                h-on="click: onClick()"
            >
            </button>
            <script h-script>
                {
                    onInit: function(details) {
                        if(!this.$state.color)
                            this.$model.color = "gray";
                        if(!this.$state.text)
                            this.$model.text = "Button";
                        if(!this.$state.onClick)
                            this.$model.onClick = () => console.log("click");
                    }
                }
            </script>
        </template>

        <template h-template="app-tasks" h-model="tasks" h-route="#home" h-routing="resolve">
            <p h-model="^" h-property="textContent: `Total: ${tasks.length}`"></p>
            <app-add-task h-model="^.addTask"></app-add-task>
            <app-task-item h-model="^.tasks"></app-task-item>
            <script h-script>
                {
                    onInit: function() {
                        this.$model.tasks = TaskService.loadTasks();
                        const component = this;
                        this.$model.addTask = {
                            task: new Task(),
                            showAddTask: true,
                            addTask: function(task) {
                                component.addTask(task);
                            }
                        }
                    },
                    addTask: function(task) {
                        let tasks = this.$state.tasks;
                        task.id = tasks.reduce((x, y) => y > x ? y : x, 1);
                        tasks.push(task);
                        TaskService.saveTasks(tasks);
                        this.$model.tasks = tasks;
                        this.$model.addTask.task = new Task();
                    }
                }
            </script>
        </template>

        <template h-template="app-add-task" h-model="addTask">
            <div class="add-form"
                h-model="ui.addTask"
                h-toggle="hidden: !show"
            >
                <div class="form-control">
                <label for="text">Task</label>
                <input type="text" name="text" id="text" placeholder="Add Task"
                  h-model="^.task" h-property="value: text" h-input="text: $element.value"
                />
                </div>
                <div class="form-control">
                <label for="day">Day & Time</label>
                <input type="text" name="day" id="day" placeholder="Add Day & Time"
                    h-model="^.task" h-property="value: day" h-input="day: $element.value"
                />
                </div>
                <div class="form-control form-control-check">
                <label for="reminder">Set Reminder</label>
                <input type="checkbox" name="reminder" id="reminder"
                    h-model="^.task" h-property="value: reminder" h-input="reminder: $element.value"
                />
                </div>
                <button class="btn btn-block"
                    h-model="^" h-on="click: addTask(task)"
                >
                    Save Task
                </button>
            </div>
        </template>

        <template h-template="app-task-item">
            <div class="task"
                h-model="^"
                h-class="reminder: reminder"
                h-on="dblclick: $component.toggleReminder($state)">
                <h3>
                    <span h-model="^" h-property="textContent: text"></span>
                    <i style="font-size: x-large;"
                        h-model="^"
                        h-on="click: $component.deleteTask($state)"
                    >X</i>
                </h3>
                <p h-model="^" h-property="textContent: day"></p>
            </div>
            <script h-script>
                {
                    toggleReminder: function(task) {
                        const tasks = this.$state;
                        let index = tasks.indexOf(task);
                        if(index < 0)
                            return;
                        this.$model[index].reminder = !task.reminder;
                        TaskService.saveTasks(tasks);
                    },
                    deleteTask: function(task) {
                        const tasks = this.$state;
                        let index = tasks.indexOf(task);
                        if(index < 0)
                            return;
                        tasks.splice(index, 1);
                        TaskService.saveTasks(tasks);
                        this.$hydrate.parent(this.$model).tasks = tasks;
                    }
                }
            </script>
        </template>

        <template h-template="app-about" h-model h-route="#about" h-routing="resolve">
            <div>
                <h2>Task Tracker</h2>
                <h4>Version: 1.0</h4>
                <a href="#home">Go Back</a>
            </div>
        </template>

        <template h-template="app-footer" h-model>
            <footer>
                <p>Copyright &copy; 2021</p>
                <a href="#about">About</a>
            </footer>
        </template>

        <div class="container">
            <app-header></app-header>
            <app-tasks></app-tasks>
            <app-about></app-about>
            <app-footer></app-footer>
        </div>

        <script>
            class Task {
                id = null;
                text = null;
                day = null;
                reminder = false;
            }

            class TaskService
            {
                static loadTasks() {
                    // return [
                    //     {text: "hello", day: "Today", reminder:true}
                    // ]
                    let tasks = window.localStorage.getItem("todos") ?? "[]";
                    return JSON.parse(tasks);
                }
                static saveTasks(tasks) {
                    window.localStorage.setItem("todos", JSON.stringify(tasks));
                }
                static createTask() {
                    return new Task();
                }
            }
            class UiService {

            }

            let hydrate = new HydrateApp();
            hydrate.bind("header", {
                title: "Task Tracker"
            });
            hydrate.bind("tasks");
            hydrate.bind("addTask");
            let ui = {
                addTask: {
                    show: false,
                    toggleShow: function() {
                        this.show = !this.show;
                        this.updateButtonState();
                    },
                    updateButtonState: function() {
                        if(this.show) {
                            this.button.text = "Close",
                            this.button.color = "red";
                        } else {
                            this.button.text = "Add";
                            this.button.color = "green";
                        }
                    },
                    button: {
                        text: "Add",
                        color: "green",
                        onClick: null
                    }
                }
            };
            ui.addTask.updateButtonState();
            const uiModel = hydrate.bind("ui", ui);
            ui.addTask.button.onClick = function() {
                uiModel.addTask.toggleShow();
            }
            
            let appRoutes = [
                {path: "#home", action: request => request.resolve()},
                {path: "#about", action: request => request.resolve()},
                {path: "", action: request => request.redirect("#home")},
            ];
            document.addEventListener("hydrate.routing.start", event => {
                try {
                    let request = event.detail.request;
                    let matches = request.match(request.url, ...appRoutes);
                    for(let match of matches) {
                        match.route.action(request);
                        if(request.handled)
                            return;
                    }
                }
                catch(error) {
                    console.error(error);
                }
                request.reject();
            });
            hydrate.route();

        </script>
    </body>
</html>